<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.mapper.AccountMapper">
	
	<select id="NowDateKey" resultType="String">
		SELECT DATE_FORMAT(NOW(6), '%Y%m%d%H%i%s%f')
	</select>
	
	<select id="AccountList" parameterType="int" resultType="hashmap">
		SELECT account_id, 
			   account_name, 
			   concat(ifnull(account_address,''), ' ', ifnull(account_address_detail,'')) as account_address,
			   case account_type when 1 then '요양원' when 2 then '도소매' when 3 then '프랜차이즈' when 4 then '산업체' else '학교' end as account_type, 
			   account_rqd_member,
			   account_headcount,
			   meal_type,
			   del_yn
		FROM tb_account
		WHERE del_yn = 'N'
		<if test='accountType == 0'>
			AND account_type in (1,2,4,5)
 		</if>
 		<if test='accountType != 0'>
			AND account_type = #{accountType}
 		</if>
 		AND account_id not in 
 		(
 			20260122065002,
			20260122071337,
			20260122071857,
			20260122072114,
			20260122072245,
			20260122072529,
			20260122072732,
			20260126093618,
			20260126093730,
			20260126093808,
			20260127025350,
			20260127025437,
			20260127025657,
			20260219024021
 		)
	</select>
	
	<select id="AccountListV2" parameterType="int" resultType="hashmap">
		SELECT account_id, 
			   account_name, 
			   concat(ifnull(account_address,''), ' ', ifnull(account_address_detail,'')) as account_address,
			   case account_type when 1 then '요양원' when 2 then '도소매' when 3 then '프랜차이즈' when 4 then '산업체' else '학교' end as account_type, 
			   account_rqd_member,
			   account_headcount,
			   meal_type,
			   del_yn
		FROM tb_account
		WHERE del_yn = 'N'
		<if test='accountType == 0'>
			AND account_type in (1,2,4,5)
 		</if>
 		<if test='accountType != 0'>
			AND account_type = #{accountType}
 		</if>
 		AND account_id not in 
 		(
 			20260122065002,
			20260122071337,
			20260122071857,
			20260122072114,
			20260122072245,
			20260122072529,
			20260122072732,
			20260219024021
 		)
	</select>
	
	<select id="AccountDirectList" resultType="hashmap">
		SELECT account_id, 
			   account_name, 
			   concat(ifnull(account_address,''), ' ', ifnull(account_address_detail,'')) as account_address
		FROM tb_account
		WHERE account_type = 3
		ORDER BY account_type DESC
	</select>
	
	<select id="AccountMemberList" resultType="map">
		SELECT user_name, user_type
		FROM tb_user
		WHERE user_id = #{userId}
		AND password = #{password}
	</select>
	
	<select id="AccountUtilMemberList" parameterType="map" resultType="map">
		SELECT member_id, name, position_type
		FROM tb_account_members T
		WHERE position_type in (6,7)
		AND del_yn = 'N'
	</select>
	
	<select id="AccountUtilMappingList" parameterType="map" resultType="map">
		SELECT T2.idx, T2.account_id, T.member_id, T.name, T.position_type
		FROM tb_account_members T
		JOIN tb_account_util_member_mapping T2
		ON T2.member_id = T.member_id
		WHERE T.position_type IN (6,7)
		AND IFNULL(T.del_yn, 'N') = 'N'
		AND IFNULL(T2.del_yn, 'N') = 'N'
		<choose>
			<when test="member_id != null and member_id != ''">
				AND T2.member_id = #{member_id}
			</when>
			<when test="user_id != null and user_id != ''">
				AND (
					-- 기존 데이터(member_id=user_id)와 신규 데이터(user_id 컬럼 저장)를 모두 대응
					T2.member_id = #{user_id}
					OR T2.member_id IN (
						SELECT M.member_id
						FROM tb_account_members M
						WHERE M.user_id = #{user_id}
						AND IFNULL(M.del_yn, 'N') = 'N'
						AND M.position_type IN (6,7)
					)
				)
			</when>
			<otherwise>
				AND 1 = 0
			</otherwise>
		</choose>
	</select>
	
	<insert id="AccountUtilMemberMappingSave" parameterType="map">
		INSERT INTO tb_account_util_member_mapping
		(idx, member_id, account_id, del_yn, reg_dt, user_id)
		VALUES
		(#{idx}, #{member_id}, #{account_id}, 'N', DATE_FORMAT(NOW(), '%Y-%m-%d'), #{user_id})
		ON DUPLICATE KEY UPDATE
		member_id = #{member_id},
		account_id = #{account_id},
		del_yn = #{del_yn}
	</insert>
	
	<insert id="AccountMemberSave" parameterType="map">
		INSERT INTO tb_account_members (
		    member_id, account_id, name, join_dt, del_dt, 
		    del_yn, position, work_system, start_time, end_time, 
		    salary, relation, del_note, rct_notice, note, 
		    position_type, address, rrn, account_number, phone, 
		    contract_type, act_join_dt, ret_set_dt, national_pension, health_insurance, 
		    industrial_insurance, employment_insurance, employment_contract, subsidy, headoffice_note, 
		    loss_major_insurances
		)
		VALUES (
		    #{member_id},
		    #{account_id},
		    #{name},
		    DATE_FORMAT(#{join_dt}, '%Y-%m-%d'),
		    DATE_FORMAT(#{del_dt}, '%Y-%m-%d'),
		    #{del_yn},
		    #{position},
		    #{work_system},
		    #{start_time},
		    #{end_time},
		    #{salary},
		    #{relation},
		    #{del_note},
		    #{rct_notice},
		    #{note},
		    #{position_type},
		    #{address},
		    #{rrn},
		    #{account_number},
		    #{phone},
		    #{contract_type},
		    DATE_FORMAT(#{act_join_dt}, '%Y-%m-%d'),
		    DATE_FORMAT(#{ret_set_dt}, '%Y-%m-%d'),
		    DATE_FORMAT(#{national_pension}, '%Y-%m-%d'),
		    DATE_FORMAT(#{health_insurance}, '%Y-%m-%d'),
		    DATE_FORMAT(#{industrial_insurance}, '%Y-%m-%d'),
		    DATE_FORMAT(#{employment_insurance}, '%Y-%m-%d'),
		    #{employment_contract},
		    #{subsidy},
		    #{headoffice_note},
		    DATE_FORMAT(#{loss_major_insurances}, '%Y-%m-%d')
		)
		ON DUPLICATE KEY UPDATE
		    account_id = VALUES(account_id),
		    name = VALUES(name),
		    join_dt = VALUES(join_dt),
		    del_dt = VALUES(del_dt),
		    del_yn = VALUES(del_yn),
		    position = VALUES(position),
		    work_system = VALUES(work_system),
		    start_time = VALUES(start_time),
		    end_time = VALUES(end_time),
		    salary = VALUES(salary),
		    relation = VALUES(relation),
		    del_note = VALUES(del_note),
		    rct_notice = VALUES(rct_notice),
		    note = VALUES(note),
		    position_type = VALUES(position_type),
		    address = VALUES(address),
		    rrn = VALUES(rrn),
		    account_number = VALUES(account_number),
		    phone = VALUES(phone),
		    contract_type = VALUES(contract_type),
		    act_join_dt = VALUES(act_join_dt),
		    ret_set_dt = VALUES(ret_set_dt),
		    national_pension = VALUES(national_pension),
		    health_insurance = VALUES(health_insurance),
		    industrial_insurance = VALUES(industrial_insurance),
		    employment_insurance = VALUES(employment_insurance),
		    employment_contract = VALUES(employment_contract),
		    subsidy = VALUES(subsidy),
		    headoffice_note = VALUES(headoffice_note),
		    loss_major_insurances = VALUES(loss_major_insurances);
	</insert>
	
	<select id="AccountTallySheetList" parameterType="map" resultType="hashmap">
		SELECT (SELECT name FROM tb_account_mapping WHERE type = amv.type) as name, 
			amv.type,
			amv.account_id,
			#{year} as count_year,
			#{month} as count_month,
		   	ifnull(FORMAT(ats.day_1, 0), 0) as day_1,
			ifnull(FORMAT(ats.day_2, 0), 0) as day_2,
			ifnull(FORMAT(ats.day_3, 0), 0) as day_3,
			ifnull(FORMAT(ats.day_4, 0), 0) as day_4,
			ifnull(FORMAT(ats.day_5, 0), 0) as day_5,
			ifnull(FORMAT(ats.day_6, 0), 0) as day_6,
			ifnull(FORMAT(ats.day_7, 0), 0) as day_7,
			ifnull(FORMAT(ats.day_8, 0), 0) as day_8,
			ifnull(FORMAT(ats.day_9, 0), 0) as day_9,
			ifnull(FORMAT(ats.day_10, 0), 0) as day_10,
			ifnull(FORMAT(ats.day_11, 0), 0) as day_11,
			ifnull(FORMAT(ats.day_12, 0), 0) as day_12,
			ifnull(FORMAT(ats.day_13, 0), 0) as day_13,
			ifnull(FORMAT(ats.day_14, 0), 0) as day_14,
			ifnull(FORMAT(ats.day_15, 0), 0) as day_15,
			ifnull(FORMAT(ats.day_16, 0), 0) as day_16,
			ifnull(FORMAT(ats.day_17, 0), 0) as day_17,
			ifnull(FORMAT(ats.day_18, 0), 0) as day_18,
			ifnull(FORMAT(ats.day_19, 0), 0) as day_19,
			ifnull(FORMAT(ats.day_20, 0), 0) as day_20,
			ifnull(FORMAT(ats.day_21, 0), 0) as day_21,
			ifnull(FORMAT(ats.day_22, 0), 0) as day_22,
			ifnull(FORMAT(ats.day_23, 0), 0) as day_23,
			ifnull(FORMAT(ats.day_24, 0), 0) as day_24,
			ifnull(FORMAT(ats.day_25, 0), 0) as day_25,
			ifnull(FORMAT(ats.day_26, 0), 0) as day_26,
			ifnull(FORMAT(ats.day_27, 0), 0) as day_27,
			ifnull(FORMAT(ats.day_28, 0), 0) as day_28,
			ifnull(FORMAT(ats.day_29, 0), 0) as day_29,
			ifnull(FORMAT(ats.day_30, 0), 0) as day_30,
			ifnull(FORMAT(ats.day_31, 0), 0) as day_31
		FROM tb_account_mapping_v2 amv  
		LEFT OUTER JOIN tb_account_tally_sheet ats
		ON ats.account_id = amv.account_id
        AND ats.type = amv.type
		AND ats.count_year = #{year}
		AND ats.count_month = #{month}
		WHERE amv.account_id = #{account_id}
        AND amv.del_yn = 'N'
		ORDER BY amv.type asc
	</select>
	
	<insert id="TallySheetSave" parameterType="map">
		INSERT INTO tb_account_tally_sheet
		(account_id, type, count_year, count_month, day_1, day_2, day_3, day_4, day_5, day_6, day_7, day_8, day_9, day_10, day_11, day_12, day_13, day_14, day_15, day_16, day_17, day_18, day_19, day_20, day_21, day_22, day_23, day_24, day_25, day_26, day_27, day_28, day_29, day_30, day_31)
		VALUES
		(#{account_id}, #{type}, #{count_year}, #{count_month}, #{day_1}, #{day_2}, #{day_3}, #{day_4}, #{day_5}, #{day_6}, #{day_7}, #{day_8}, #{day_9}, #{day_10}, #{day_11}, #{day_12}, #{day_13}
		, #{day_14}, #{day_15}, #{day_16}, #{day_17}, #{day_18}, #{day_19}, #{day_20}, #{day_21}, #{day_22}, #{day_23}, #{day_24}, #{day_25}, #{day_26}, #{day_27}, #{day_28}, #{day_29}, #{day_30}, #{day_31})
		ON DUPLICATE KEY UPDATE
		account_id = #{business_report}, type = #{business_report}, count_year = #{business_report}, count_month = #{business_report}, 
		day_1 = #{day_1}, day_2 = #{day_2}, day_3 = #{day_3}, day_4 = #{day_4}, day_5 = #{day_5}, day_6 = #{day_6}, day_7 = #{day_7}, day_8 = #{day_8}, day_9 = #{day_9}, day_10 = #{day_10}, 
		day_11 = #{day_11}, day_12 = #{day_12}, day_13 = #{day_13}, day_14 = #{day_14}, day_15 = #{day_15}, day_16 = #{day_16}, day_17 = #{day_17}, day_18 = #{day_18}, day_19 = #{day_19}, day_20 = #{day_20}, 
		day_21 = #{day_21}, day_22 = #{day_22}, day_23 = #{day_23}, day_24 = #{day_24}, day_25 = #{day_25}, day_26 = #{day_26}, day_27 = #{day_27}, day_28 = #{day_28}, day_29 = #{day_29}, day_30 = #{day_30}, day_31 = #{day_31}
	</insert>
	
	<insert id="AccountSave" parameterType="map">
	    INSERT INTO tb_account (
	        account_id,
	        <if test="account_name != null and account_name != ''">account_name,</if>
	        <if test="account_address != null and account_address != ''">account_address,</if>
	        <if test="account_address_detail != null and account_address_detail != ''">account_address_detail,</if>
	        <if test="account_rqd_member != null">account_rqd_member,</if>
	        <if test="account_headcount != null">account_headcount,</if>
	        <if test="phone != null and phone != ''">phone,</if>
	        <if test="account_type != null and account_type != ''">account_type,</if>
	        <if test="meal_type != null and meal_type != ''">meal_type,</if>
	        <if test="del_yn != null and del_yn != ''">del_yn,</if>
	        reg_dt
	    )
	    VALUES (
	        COALESCE(#{account_id}, DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')),
	        <if test="account_name != null and account_name != ''">#{account_name},</if>
	        <if test="account_address != null and account_address != ''">#{account_address},</if>
	        <if test="account_address_detail != null and account_address_detail != ''">#{account_address_detail},</if>
	        <if test="account_rqd_member != null">#{account_rqd_member},</if>
	        <if test="account_headcount != null">#{account_headcount},</if>
	        <if test="phone != null and phone != ''">#{phone},</if>
	        <if test="account_type != null and account_type != ''">#{account_type},</if>
	        <if test="meal_type != null and meal_type != ''">#{meal_type},</if>
	        <if test="del_yn != null and del_yn != ''">#{del_yn},</if>
	        DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s')
	    )
	    ON DUPLICATE KEY UPDATE
	        reg_dt = DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s')
	        <if test="account_name != null and account_name != ''">, account_name = #{account_name}</if>
	        <if test="account_address != null and account_address != ''">, account_address = #{account_address}</if>
	        <if test="account_address_detail != null and account_address_detail != ''">, account_address_detail = #{account_address_detail}</if>
	        <if test="account_rqd_member != null">, account_rqd_member = #{account_rqd_member}</if>
	        <if test="account_headcount != null">, account_headcount = #{account_headcount}</if>
	        <if test="phone != null and phone != ''">, phone = #{phone}</if>
	        <if test="account_type != null and account_type != ''">, account_type = #{account_type}</if>
	        <if test="meal_type != null and meal_type != ''">, meal_type = #{meal_type}</if>
	        <if test="del_yn != null and del_yn != ''">, del_yn = #{del_yn}</if>
	        <if test='del_yn == "Y"'>, del_dt = DATE_FORMAT(NOW(), '%Y-%m-%d')</if>
	</insert>
	
	<select id="AccountRecordSheetList" parameterType="map" resultType="hashmap">
		SELECT X.account_id
			 , X.gubun
			 , X.member_id
			 , X.position
             , X.position_type
			 , X.name
			 , X.record_year
			 , X.record_month
			 , X.record_date
			 , X.type
			 , X.start_time
			 , X.end_time
			 , X.salary
		     , X.note
		     , X.act_join_dt
		     , X.pay_yn
		FROM
		(
			SELECT
            'nor' as gubun,
		    T2.account_id,
		    T2.member_id,
		    T2.position,
            T2.position_type,
		    T2.name,
		    T.record_year,
		    T.record_month,
		    T.record_date,
		    T.type,
		    T.start_time,
		    T.end_time,
		    CASE WHEN T.type = 6 THEN T.salary ELSE 0 END AS salary,
		    T.note
		    , '' as act_join_dt
		    , '' as pay_yn
		FROM tb_account_members T2 
		LEFT JOIN tb_account_record T
		    ON T.account_id = T2.account_id
		    AND T.member_id = T2.member_id
		    AND T.record_year = #{year}
		    AND T.record_month = #{month}
		WHERE T2.account_id = #{account_id}
		AND IFNULL(T2.display_yn,'Y') = 'Y'
		UNION ALL
		-- 아래는 직원파출.
		SELECT 'nor' as gubun,
	       T.dispatch_account_id as account_id,
	       T.member_id,
	       T3.position,
	       T3.position_type,
	       T3.name,
	       T2.record_year,
	       T2.record_month,
	       T2.record_date,
	       T2.type,
	       T2.start_time,
	       T2.end_time,
		   T2.salary,
	       T2.note,
	       '' as act_join_dt,
	       '' as pay_yn
	FROM tb_account_member_dispatch_mapping T
	JOIN tb_account_record T2
	    ON T.dispatch_account_id = T2.account_id 
	    AND T.member_id = T2.member_id  -- ⭐ 이 조건이 반드시 필요합니다!
	JOIN tb_account_members T3
	    ON T3.member_id = T.member_id
	WHERE T.dispatch_account_id = #{account_id}
	  AND T.record_year = #{year}
	  AND T.record_month = #{month}
		UNION ALL
		-- 아래는 유틸 직원
		SELECT
            'nor' as gubun,
          T.account_id,
          T.member_id,
          T2.position,
            T2.position_type,
          T2.name,
          T3.record_year,
          T3.record_month,
          T3.record_date,
          T3.type,
          T3.start_time,
          T3.end_time,
          CASE WHEN T3.type = 6 THEN T2.salary ELSE 0 END AS salary,
          T2.note
          , '' as act_join_dt
          , '' as pay_yn
         from tb_account_util_member_mapping T
         join tb_account_members T2
         on T2.member_id = T.member_id
         left join tb_account_record T3
         on T3.account_id = T.account_id
         and T3.member_id = T.member_id
         AND T3.record_year = #{year}
       AND T3.record_month = #{month}
         AND type = 7
         where T.account_id = #{account_id}
          AND IFNULL(T2.display_yn,'Y') = 'Y'
        UNION ALL
		SELECT
			'rec' as gubun,
		    T2.account_id,
		    T2.member_id,
			T2.position,
            T2.position_type,
		    T2.name,
		    T.record_year,
		    T.record_month,
		    T.record_date,
		    T.type,
		    T.start_time,
		    T.end_time,
		    T.salary,
		    T.note
		    , DATE_FORMAT(T2.act_join_dt, '%Y-%m-%d') as act_join_dt
		    , '' as pay_yn
		FROM tb_account_rec_management T2  
		LEFT JOIN tb_account_rec_record T
		    ON T.account_id = T2.account_id
		    AND T.member_id = T2.member_id
		    AND T.record_year = #{year}   
		    AND T.record_month = #{month}
		    AND (
		    	T2.act_join_dt IS NULL
		    	OR T2.act_join_dt <![CDATA[ < ]]> STR_TO_DATE(CONCAT(#{year}, '-', LPAD(#{month}, 2, '0'), '-01'), '%Y-%m-%d')
		    	OR T.record_date >= DAY(T2.act_join_dt)
		    )
		WHERE T2.account_id = #{account_id}
		AND T2.use_yn = 'D'
		AND (
			T2.act_join_dt IS NULL
			OR T2.act_join_dt <![CDATA[ < ]]> DATE_ADD(
				STR_TO_DATE(CONCAT(#{year}, '-', LPAD(#{month}, 2, '0'), '-01'), '%Y-%m-%d'),
				INTERVAL 1 MONTH
			)
		)
        UNION ALL
        SELECT
			'dis' as gubun,
		    T2.account_id,
		    T2.member_id,
			'' as position,
            '' as position_type,
		    T2.name,
		    T.record_year,
		    T.record_month,
		    T.record_date,
		    ifnull(T.type, 5) as type,
		    T.start_time,
		    T.end_time,
		    T.salary,
		    T.note
		    , '' as act_join_dt
		    , ifnull(T.pay_yn,'N') as pay_yn
		FROM tb_account_members_dispatch T2  
		LEFT JOIN tb_account_record_dispatch T
		    ON T.account_id = T2.account_id
		    AND T.member_id = T2.member_id
		    AND T.record_year = T2.record_year
            AND T.record_month = T2.record_month
		WHERE T2.account_id = #{account_id}
			AND T2.record_year = #{year}  
		    AND T2.record_month = #{month}
			AND T2.del_yn = 'N'
		) as X
		ORDER BY CASE X.gubun WHEN 'nor' THEN 1
							  WHEN 'rec' THEN 2
                              ELSE 3 END
				 , CASE X.position_type WHEN 1 THEN 1
								   WHEN 2 THEN 2
								   WHEN 3 THEN 3
								   ELSE 4 END
				 , CASE
				     WHEN X.account_id = '20250819193632'
				      AND X.member_id = '20260123085804162515037' THEN 0
				     WHEN X.account_id = '20250819193632'
				      AND X.member_id = '20260123085804162515030' THEN 1
				     ELSE 2
				   END
				 , X.member_id;
	</select>
	
	<select id="AccountRecordDispatchList" parameterType="map" resultType="hashmap">
      SELECT
          subquery.member_id,
          subquery.account_id,
          subquery.name,
          subquery.phone,
          CONCAT(subquery.work_cnt , "회, ", subquery.salary, "원") as total,
          IFNULL(subquery.salary, 0) as salary,
          subquery.rrn,
          subquery.account_number,
            subquery.dispatch_account,
            subquery.note,
          subquery.del_yn
      FROM (
          SELECT
              T.member_id,
              T.account_id,
              T.name,
              T.phone,
              T.rrn,
              T.account_number,
                T.dispatch_account,
                T.note,
              COUNT(CASE WHEN T2.is_present = 'Y' THEN 1 ELSE 0 END) AS work_cnt,
                IFNULL(SUM(salary),0) as salary,
              T.del_yn
          FROM tb_account_members_dispatch AS T
          LEFT JOIN tb_account_record_dispatch AS T2
          ON T.account_id = T2.account_id 
          AND T.member_id = T2.member_id
          AND T.record_year = T2.record_year
            AND T.record_month = T2.record_month
          WHERE T.record_year = #{year}
         AND T.record_month = #{month}
         AND T.account_id = #{account_id}
         <if test="del_yn != null">
            AND T.del_yn = #{del_yn}
         </if>
            AND T2.is_present = 'Y'
          GROUP BY T.member_id, T.account_id, T.name, T.phone, T.rrn, T.account_number, T.dispatch_account, T.note, T2.is_present
      ) AS subquery
      ORDER BY subquery.member_id
   </select>
	
	<select id="AccountRecordMemberList" parameterType="map" resultType="hashmap">
		SELECT
		    subquery.member_id,
		    subquery.account_id,
		    subquery.name,
		    subquery.del_yn,
		    ifnull(subquery.salary,0) AS salary,
		    CASE WHEN subquery.position_type = 1 THEN '영양사'
		         WHEN subquery.position_type = 2 THEN '조리팀장'
		         WHEN subquery.position_type = 3 THEN '조리장'
		         WHEN subquery.position_type = 4 THEN '조리사'
		         WHEN subquery.position_type = 5 THEN '조리원'
		         ELSE '유틸' END AS position,
		    CONCAT('근로일수 : ', ifnull(subquery.working_day,0), '회') as working_day,
		    CONCAT('총 ',ifnull(subquery.employ_dispatch_cnt,0), '회,', ' 합계금액 : ', ifnull(subquery.employ_dispatch_salary,0)) AS employ_dispatch,
		    ifnull(subquery.employ_dispatch_cnt,0) as employ_dispatch_cnt,
		    ifnull(subquery.employ_dispatch_salary,0) as employ_dispatch_salary,
		    CONCAT('초과 : ', ifnull(subquery.over_work,0), '회') as over_work,
		    ifnull(subquery.over_work,0) AS over_count,
		    CONCAT('결근 : ', ifnull(subquery.non_work,0), '회') as non_work,
		    ifnull(subquery.non_work,0) AS non_count,
		    subquery.note
		FROM (
		    SELECT
		        T.member_id,
		        T.account_id,
		        T.name,
		        T.del_yn,
		        T.position_type,
		        T.salary,
		        -- 파출 급여
		        (SELECT SUM(T2.salary)
		         FROM tb_account_member_dispatch_mapping TM
		         JOIN tb_account_record T2 ON TM.dispatch_account_id = T2.account_id AND TM.member_id = T2.member_id
		         WHERE TM.member_id = T.member_id  
		           AND TM.account_id = #{account_id}
		           AND T2.record_year = #{year} AND T2.record_month = #{month} AND T2.type = 6
		           AND TM.del_yn = 'N'
		        ) AS employ_dispatch_salary,
		        -- 파출 횟수
		        (SELECT COUNT(1)
		         FROM tb_account_member_dispatch_mapping TM
		         JOIN tb_account_record T2 ON TM.dispatch_account_id = T2.account_id AND TM.member_id = T2.member_id
		         WHERE TM.member_id = T.member_id 
		           AND TM.account_id = #{account_id}
		           AND T2.record_year = #{year} AND T2.record_month = #{month} AND T2.type = 6
		           AND TM.del_yn = 'N'
		        ) AS employ_dispatch_cnt,
		        (SELECT count(1) FROM tb_account_record WHERE account_id = T.account_id AND member_id = T.member_id AND type = 3 AND record_year = #{year} AND record_month = #{month}) AS over_work,
		        (SELECT count(1) FROM tb_account_record WHERE account_id = T.account_id AND member_id = T.member_id AND type = 4 AND record_year = #{year} AND record_month = #{month}) AS non_work,
		        (SELECT COUNT(DISTINCT total_dates.record_date)
		         FROM (
		            SELECT record_date, account_id, member_id, type, record_year, record_month FROM tb_account_record
		            UNION ALL
		            SELECT record_date, account_id, member_id, type, record_year, record_month FROM tb_account_rec_record
		         ) AS total_dates
		         WHERE total_dates.account_id = T.account_id 
		           AND total_dates.member_id = T.member_id
		           AND total_dates.type IN (1,2,3)
		           AND total_dates.record_year = #{year} 
		           AND total_dates.record_month = #{month}
		        ) AS working_day,
		        T.note
		    FROM tb_account_members AS T
		    WHERE T.account_id = #{account_id}
		      AND IFNULL(T.display_yn,'Y') = 'Y'
		    GROUP BY T.member_id, T.account_id, T.name, T.note, T.del_yn, T.position_type
		) AS subquery
		ORDER BY
		    subquery.position_type ASC,
		    CASE
		        WHEN subquery.account_id = '20250819193632' AND subquery.member_id = '20260123085804162515037' THEN 0
		        WHEN subquery.account_id = '20250819193632' AND subquery.member_id = '20260123085804162515030' THEN 1
		        ELSE 2
		    END ASC,
		    subquery.member_id DESC;
	</select>
	
	<select id="AccountMemberRecordTime" parameterType="map" resultType="hashmap">
		SELECT member_id,
			   account_id,
			   start_time,
			   end_time
		FROM tb_account_members T
		WHERE account_id = #{account_id}
		AND IFNULL(display_yn,'Y') = 'Y'
        UNION ALL
              SELECT member_id,
			   account_id,
			   start_time,
			   end_time
		FROM tb_account_rec_management
		WHERE account_id = #{account_id}
		AND use_yn = 'D'
		UNION ALL
		SELECT T.member_id, T.account_id, T2.start_time, T2.end_time
		FROM tb_account_util_member_mapping T
		JOIN tb_account_members T2
		ON T2.member_id = T.member_id
		WHERE T.account_id = #{account_id}
		AND T.del_yn = 'N'
	</select>
	
	<insert id="AccountMemberRecordSave" parameterType="map">
		INSERT INTO tb_account_record
		(account_id, member_id, record_date, type, record_year, record_month, start_time, end_time, note, salary)
		VALUES
		(#{account_id}, #{member_id}, #{record_date}, #{type}, #{record_year}, #{record_month}, #{start_time}, #{end_time}, #{note}, #{salary})
		ON DUPLICATE KEY UPDATE
		<!-- 직원파출(동일 날짜 중복) 저장 시 계정도 갱신 -->
		account_id = #{account_id},
		type = #{type},
		start_time = #{start_time},
		end_time = #{end_time},
		note = #{note},
		salary = #{salary}
	</insert>
	
	<insert id="AccountMemberRecRecordSave" parameterType="map">
		INSERT INTO tb_account_rec_record
		(account_id, member_id, record_date, type, record_year, record_month, start_time, end_time, note, salary)
		VALUES
		(#{account_id}, #{member_id}, #{record_date}, #{type}, #{record_year}, #{record_month}, #{start_time}, #{end_time}, #{note}, #{salary})
		ON DUPLICATE KEY UPDATE
		type = #{type},
		start_time = #{start_time},
		end_time = #{end_time},
		note = #{note},
		salary = #{salary}
	</insert>
	
	<insert id="AccountDispatchRecordSave" parameterType="map">
		INSERT INTO tb_account_record_dispatch
		(account_id, member_id, record_date, type, record_year, record_month, start_time, end_time, note, salary, pay_yn)
		VALUES
		(#{account_id}, #{member_id}, #{record_date}, #{type}, #{record_year}, #{record_month}, #{start_time}, #{end_time}, #{note}, #{salary}, IFNULL(#{pay_yn}, 'N'))
		ON DUPLICATE KEY UPDATE
		type = #{type},
		start_time = #{start_time},
		end_time = #{end_time},
		note = #{note},
		salary = #{salary},
		pay_yn = IFNULL(#{pay_yn}, 'N')
	</insert>
	
	<insert id="AccountDispatchMemberSave" parameterType="map">
		INSERT INTO tb_account_members_dispatch
		(account_id, member_id, name, phone, rrn, account_number, note, del_yn, dispatch_account, record_year, record_month)
		VALUES
		(#{account_id}, #{member_id}, #{name}, #{phone}, #{rrn}, #{account_number}, #{note}, #{del_yn}, #{dispatch_account}, #{record_year}, #{record_month})
		ON DUPLICATE KEY UPDATE
		name = #{name},
		phone = #{phone},
		rrn = #{rrn},
		account_number = #{account_number},
		note = #{note},
		del_yn = #{del_yn},
		dispatch_account = #{dispatch_account},
		record_year = #{record_year}, 
		record_month = #{record_month}
	</insert>
	
	<select id="AccountPropertiesList" parameterType="map" resultType="hashmap">
		SELECT *
		FROM tb_account_property
		WHERE account_id = #{account_id}
	</select>
	
	<select id="AccountInfoList" parameterType="map" resultType="hashmap">
		SELECT T.account_id, 
				T.account_name, 
		        T.account_address, 
		        account_address_detail,
		        T2.manager_name, 
		        T2.manager_tel,
		        T2.manager_name2,
		        T2.manager_tel2,
		        T2.closing_name,
		        T2.closing_tel,
		        T2.property_note,
		        T2.property_as_note,
		        T2.business_note,
		        DATE_FORMAT(T2.contract_start, '%Y-%m-%d') as contract_start, 
        		DATE_FORMAT(T2.contract_end, '%Y-%m-%d') as contract_end,
        		T.account_type,
        		T.meal_type,
        		T2.industry_note
		FROM tb_account T
		LEFT OUTER JOIN tb_account_info T2
		ON T.account_id = T2.account_id
		WHERE T.account_id = #{account_id}
	</select>
	
	<select id="AccountInfoList_2" parameterType="map" resultType="hashmap">
		SELECT T.account_id, 
				T2.diet_price,
				T2.basic_price,
		        T2.before_diet_price,
		        DATE_FORMAT(T2.after_dt, '%Y-%m-%d') as after_dt,
		        T2.elderly,
		        T2.snack,
		        T2.employ,
		        T2.full_room,
		        T2.basic,
		        T2.normal,
		        T2.eat_snack,
		        T2.ceremony,
		        T2.eat_employ,
		        T2.food_process,
		        T2.food_process_type,
		        T2.dishwasher,
		        T2.dishwasher_cnt,
		        T2.cesco,
		        T2.water_puri,
		        T2.water_puri_cnt,
		        T2.utility_bills,
		        T.account_type,
		        T2.industry_note,
		        T2.expenses_note,
		        T2.extra_diet1_name,
		        T2.extra_diet2_name,
		        T2.extra_diet3_name,
		        T2.extra_diet4_name,
		        T2.extra_diet5_name,
		        T2.extra_diet1_price,
		        T2.extra_diet2_price,
		        T2.extra_diet3_price,
		        T2.extra_diet4_price,
		        T2.extra_diet5_price
		FROM tb_account T
		LEFT OUTER JOIN tb_account_info T2
		ON T.account_id = T2.account_id
		WHERE T.account_id = #{account_id}
	</select>
	
	<select id="AccountInfoList_3" parameterType="map" resultType="hashmap">
		SELECT	subquery.account_id,
		        subquery.setting_item,
		        subquery.cuisine,
		        subquery.cuisine_note,
		        subquery.name,
		        subquery.budget_note,
		        -- subquery2에서 이미 합산된 결과를 가져와서 문자열 생성
		        CAST(
		          CONCAT(
		            IF(subquery2.total_cnt1 > 0, CONCAT('조리팀장 : ', subquery2.total_cnt1, '명\n'), ''),
		            IF(subquery2.total_cnt2 > 0, CONCAT('조리장 : ', subquery2.total_cnt2, '명\n'), ''),
		            IF(subquery2.total_cnt3 > 0, CONCAT('조리사 : ', subquery2.total_cnt3, '명\n'), ''),
		            IF(subquery2.total_cnt4 > 0, CONCAT('조리원 : ', subquery2.total_cnt4, '명'), '')
		          ) AS CHAR(255) CHARACTER SET utf8mb4
		        ) AS members,
		        REPLACE(GROUP_CONCAT(DISTINCT subquery3.work_system, " : ", subquery3.work_cnt, "명 \n"), ',', '') as work_system,
		        subquery.breakfast_time, subquery.lunch_time, subquery.dinner_time, subquery.snack_time
		FROM (
		    SELECT
		        T.account_id, T1.setting_item, T1.cuisine, T1.cuisine_note, T2.name, T1.budget_note,
		        T1.breakfast_time, T1.lunch_time, T1.dinner_time, T1.snack_time
		    FROM tb_account T
		    LEFT JOIN tb_account_info AS T1 ON T1.account_id = T.account_id
		    LEFT JOIN tb_account_members AS T2 ON T2.account_id = T1.account_id 
		    AND T2.del_yn = 'N'
		    AND T2.position_type = 1
		    WHERE T.account_id = #{account_id}
		    GROUP BY T.account_id, T1.setting_item, T1.cuisine, T1.cuisine_note, T2.name, T1.budget_note
		) AS subquery
		JOIN (
		    -- 이 부분에서 position_type별 카운트를 한 행으로 합칩니다 (Pivot)
		    SELECT
		        T.account_id,
		        SUM(CASE WHEN T2.position_type = 2 THEN 1 ELSE 0 END) AS total_cnt1,
		        SUM(CASE WHEN T2.position_type = 3 THEN 1 ELSE 0 END) AS total_cnt2,
		        SUM(CASE WHEN T2.position_type = 4 THEN 1 ELSE 0 END) AS total_cnt3,
		        SUM(CASE WHEN T2.position_type = 5 THEN 1 ELSE 0 END) AS total_cnt4
		    FROM tb_account T
			LEFT JOIN tb_account_members T2
            ON T2.account_id = T.account_id
		    AND T.account_id = #{account_id}
		    AND T2.del_yn = 'N'
		    GROUP BY T.account_id
		) AS subquery2 ON subquery.account_id = subquery2.account_id
		JOIN (
		    SELECT T.account_id, T2.idx, T3.work_system, count(1) as work_cnt
            FROM tb_account T
            LEFT JOIN tb_account_members T2
            ON T2.account_id = T.account_id
            LEFT JOIN tb_account_member_work_system T3
            ON T3.idx = T2.idx
            AND T.account_id = #{account_id}
		    GROUP BY T.account_id, T2.idx, T3.work_system
		) AS subquery3 
        ON subquery.account_id = subquery3.account_id
		GROUP BY subquery.account_id, subquery.setting_item, subquery.cuisine, subquery.cuisine_note, 
		         subquery.name, subquery.budget_note, subquery2.total_cnt1, subquery2.total_cnt2, 
		         subquery2.total_cnt3, subquery2.total_cnt4;
	</select>
	
	<select id="AccountInfoList_4" parameterType="map" resultType="hashmap">
		SELECT puri_type,
			   gas_type,
			   business_type,
			   insurance_note,
			   finish_note
		FROM tb_account T
		LEFT OUTER JOIN tb_account_info T1
        ON T1.account_id = T.account_id
		WHERE T.account_id = #{account_id}
	</select>
	
	<select id="AccountInfoList_5" parameterType="map" resultType="hashmap">
		SELECT ifnull(T1.satis_note, '') as satis_note,
			   ifnull(T1.hygiene_note, '') as hygiene_note,
			   ifnull(T1.event_note, '') as event_note,
			   ifnull(T1.birthday_note, '') as birthday_note,
			   ifnull(T1.group_feed_yn, '') as group_feed_yn,
			   ifnull(T1.nutritionist_room_yn, '') as nutritionist_room_yn,
			   ifnull(T1.chef_lounge_yn, '') as chef_lounge_yn
		FROM tb_account T
		LEFT OUTER JOIN tb_account_info T1
        ON T1.account_id = T.account_id
		WHERE T.account_id = #{account_id}
	</select>
	
	<insert id="AccountInfoSave" parameterType="map">
		INSERT INTO tb_account_info
    
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        account_id,
	        manager_name,
	        manager_tel,
	        manager_name2,
	        manager_tel2,
	        closing_name,
	        closing_tel,
	        business_note,
	        property_note,
	        property_as_note,
	        contract_start,
	        contract_end,
	        setting_item,
	        cuisine,
	        cuisine_note,
	        budget_note,
	        food_process,
	        dishwasher,
	        cesco,
	        water_puri,
	        utility_bills,
	        diet_price,
	        basic_price,
	        before_diet_price,
	        
	        <if test="after_dt != null and after_dt != ''">
	        after_dt,
	        </if>
	        
	        elderly,
	        snack,
	        employ,
	        note,
	        full_room,
	        basic,
	        normal,
	        eat_snack,
	        ceremony,
	        eat_employ,
	        puri_type,
	        gas_type,
	        business_type,
	        insurance_note,
	        finish_note,
	        satis_note,
	        hygiene_note,
	        event_note,
	        industry_note,
	        <if test="business_report != null and business_report != ''">
	        	business_report,
	        </if>
	        <if test="business_regist != null and business_regist != ''">
	        	business_regist,
	        </if>
	        <if test="kitchen_drawing != null and kitchen_drawing != ''">
	        	kitchen_drawing,
	        </if>
	        expenses_note,
	        update_dt,
	        extra_diet1_price,
	        extra_diet2_price,
	        extra_diet3_price,
	        extra_diet4_price,
	        extra_diet5_price,
	        dishwasher_cnt,
	        water_puri_cnt,
	        food_process_type,
	        birthday_note,
	        group_feed_yn,
	        nutritionist_room_yn,
	        chef_lounge_yn,
	        <if test="nutritionist_room_img != null and nutritionist_room_img != ''">
	        	nutritionist_room_img,
	        </if>
	        <if test="chef_lounge_img != null and chef_lounge_img != ''">
	        	chef_lounge_img,
	        </if>
	        breakfast_time,
	        lunch_time,
	        dinner_time,
	        snack_time
	    </trim>
	    
	    VALUES
	    
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        #{account_id},
	        #{manager_name},
	        #{manager_tel},
	        #{manager_name2},
	        #{manager_tel2},
	        #{closing_name},
	        #{closing_tel},
	        #{business_note},
	        #{property_note},
	        #{property_as_note},
	        #{contract_start},
	        #{contract_end},
	        #{setting_item},
	        #{cuisine},
	        #{cuisine_note},
	        #{budget_note},
	        #{food_process},
	        #{dishwasher},
	        #{cesco},
	        #{water_puri},
	        #{utility_bills},
	        #{diet_price},
	        #{basic_price},
	        #{before_diet_price},
	        
	        <if test="after_dt != null and after_dt != ''">
	        DATE_FORMAT(#{after_dt}, '%Y-%m-%d'),
	        </if>
	        
	        #{elderly},
	        #{snack},
	        #{employ},
	        #{note},
	        #{full_room},
	        #{basic},
	        #{normal},
	        #{eat_snack},
	        #{ceremony},
	        #{eat_employ},
	        #{puri_type},
	        #{gas_type},
	        #{business_type},
	        #{insurance_note},
	        #{finish_note},
	        #{satis_note},
	        #{hygiene_note},
	        #{event_note},
	        #{industry_note},
	        <if test="business_report != null and business_report != ''">
	        	#{business_report},
	        </if>
	        <if test="business_regist != null and business_regist != ''">
	        	#{business_regist},
	        </if>
	        <if test="kitchen_drawing != null and kitchen_drawing != ''">
	        	#{kitchen_drawing},
	        </if>
	        #{expenses_note},
	        DATE_FORMAT(now(), '%Y-%m-%d'),
	        #{extra_diet1_price},
	        #{extra_diet2_price},
	        #{extra_diet3_price},
	        #{extra_diet4_price},
	        #{extra_diet5_price},
	        #{dishwasher_cnt},
	        #{water_puri_cnt},
	        #{food_process_type},
	        #{birthday_note},
	        #{group_feed_yn},
	        #{nutritionist_room_yn},
	        #{chef_lounge_yn},
	        <if test="nutritionist_room_img != null and nutritionist_room_img != ''">
	        	#{nutritionist_room_img},
	        </if>
	        <if test="chef_lounge_img != null and chef_lounge_img != ''">
	        	#{chef_lounge_img},
	        </if>
	        #{breakfast_time},
	        #{lunch_time},
	        #{dinner_time},
	        #{snack_time}
	    </trim>
	    ON DUPLICATE KEY UPDATE
	    <trim suffixOverrides=",">
	        account_id=#{account_id},
	        manager_name=#{manager_name},
	        manager_tel=#{manager_tel},
	        manager_name2=#{manager_name2},
	        manager_tel2=#{manager_tel2},
	        closing_name=#{closing_name},
	        closing_tel=#{closing_tel},
	        business_note=#{business_note},
	        property_note=#{property_note},
	        property_as_note=#{property_as_note},
	        contract_start=#{contract_start},
	        contract_end=#{contract_end},
	        setting_item=#{setting_item},
	        cuisine=#{cuisine},
	        cuisine_note=#{cuisine_note},
	        budget_note=#{budget_note},
	        food_process=#{food_process},
	        dishwasher=#{dishwasher},
	        cesco=#{cesco},
	        water_puri=#{water_puri},
	        utility_bills=#{utility_bills},
	        diet_price=#{diet_price},
	        basic_price=#{basic_price},
	        before_diet_price=#{before_diet_price},
	        
	        <if test="after_dt != null and after_dt != ''">
	        after_dt=DATE_FORMAT(#{after_dt}, '%Y-%m-%d'),
	        </if>
	        
	        elderly=#{elderly},
	        snack=#{snack},
	        employ=#{employ},
	        note=#{note},
	        full_room=#{full_room},
	        basic=#{basic},
	        normal=#{normal},
	        eat_snack=#{eat_snack},
	        ceremony=#{ceremony},
	        eat_employ=#{eat_employ},
	        puri_type=#{puri_type},
	        gas_type=#{gas_type},
	        business_type=#{business_type},
	        insurance_note=#{insurance_note},
	        finish_note=#{finish_note},
	        satis_note=#{satis_note},
	        hygiene_note=#{hygiene_note},
	        event_note=#{event_note},
	        industry_note=#{industry_note},
	        <if test="business_report != null and business_report != ''">
	        	business_report=#{business_report},
	        </if>
	        <if test="business_regist != null and business_regist != ''">
	        	business_regist=#{business_regist},
	        </if>
	        <if test="kitchen_drawing != null and kitchen_drawing != ''">
	        	kitchen_drawing=#{kitchen_drawing},
	        </if>
	        expenses_note=#{expenses_note},
	        update_dt=DATE_FORMAT(now(), '%Y-%m-%d'),
	        extra_diet1_price=#{extra_diet1_price},
	        extra_diet2_price=#{extra_diet2_price},
	        extra_diet3_price=#{extra_diet3_price},
	        extra_diet4_price=#{extra_diet4_price},
	        extra_diet5_price=#{extra_diet5_price},
	        dishwasher_cnt=#{dishwasher_cnt},
	        water_puri_cnt=#{water_puri_cnt},
	        food_process_type=#{food_process_type},
	        birthday_note=#{birthday_note},
	        group_feed_yn=#{group_feed_yn},
	        nutritionist_room_yn=#{nutritionist_room_yn},
	        chef_lounge_yn=#{chef_lounge_yn},
	        <if test="nutritionist_room_img != null and nutritionist_room_img != ''">
	        	nutritionist_room_img=#{nutritionist_room_img},
	        </if>
	        <if test="chef_lounge_img != null and chef_lounge_img != ''">
	        	chef_lounge_img=#{chef_lounge_img},
	        </if>
	        breakfast_time=#{breakfast_time},
	        lunch_time=#{lunch_time},
	        dinner_time=#{dinner_time},
	        snack_time=#{snack_time}
	    </trim>
	</insert>
	
	<insert id="AccountDietPriceHistorySave" parameterType="map">
		INSERT INTO tb_account_dietprice_history
		(account_id,diet_price,before_diet_price,mod_dt,user_id)
		VALUES
		(#{account_id},#{diet_price},#{before_diet_price},DATE_FORMAT(now(), '%Y-%m-%d'),#{user_id})
	</insert>
	
	<select id="AccountDietPriceHistoryList" parameterType="map" resultType="hashmap">
		SELECT T.account_id,
			   ifnull(T2.diet_price,0) as diet_price,
			   ifnull(T2.before_diet_price,0) as before_diet_price
		FROM tb_account T
        LEFT JOIN tb_account_dietprice_history T2
        ON T.account_id = T2.account_id
		WHERE T.account_id = #{account_id}
	</select>
	
	<select id="AccountBusinessImgList" parameterType="map" resultType="hashmap">
		SELECT business_report,
		       business_regist,
		       kitchen_drawing,
		       nutritionist_room_img,
		       chef_lounge_img
		FROM tb_account_info
		WHERE account_id = #{account_id}
	</select>
	
	<insert id="insertOrUpdateFile" parameterType="map">
	    INSERT INTO tb_account_info
	        (account_id, business_report, business_regist, kitchen_drawing, chef_lounge_img, nutritionist_room_img)
	    VALUES
	        (#{account_id}, #{business_report}, #{business_regist}, #{kitchen_drawing}, #{chef_lounge_img}, #{nutritionist_room_img})
	    ON DUPLICATE KEY UPDATE
	    <trim prefix="" suffix="" suffixOverrides=",">
	        <if test='business_report != null'>
	            business_report = #{business_report},
	        </if>
	        <if test='business_regist != null'>
	            business_regist = #{business_regist},
	        </if>
	        <if test='kitchen_drawing != null'>
	            kitchen_drawing = #{kitchen_drawing},
	        </if>
	        <if test='chef_lounge_img != null'>
	            chef_lounge_img = #{chef_lounge_img},
	        </if>
	        <if test='nutritionist_room_img != null'>
	            nutritionist_room_img = #{nutritionist_room_img}
	        </if>
	    </trim>
	</insert>
	
	<select id="AccountDeadlineBalanceList" parameterType="map" resultType="hashmap">
		SELECT a.account_id, 
			   a.account_name,
		       adb.year, 
			   adb.month, 
			   adb.balance_file,
			   ifnull(adb.living_cost,0) as living_cost,
		       ifnull(adb.basic_cost,0) as basic_cost,
		       ifnull(adb.employ_cost,0) as employ_cost,
		       ifnull(adb.integrity_cost,0) as integrity_cost,
		       adb.input_exp,
		       ifnull(adb.month_balance_price,0) as month_balance_price,
		       ifnull(abp.balance_price,0) as balance_price,
		       ifnull(abp.balance_price,0) as before_price,
		       ifnull(abp.before_price,0) as before_price2
		FROM tb_account a
		LEFT OUTER JOIN tb_account_deadline_balance adb
		ON adb.account_id = a.account_id
		AND adb.year = #{year}
		AND adb.month = #{month}
		LEFT OUTER JOIN tb_account_balance_price abp
		ON abp.account_id = a.account_id
		WHERE a.del_yn = 'N'
	</select>
	
	<select id="AccountDeadlineBalanceIntegrityCost" parameterType="map" resultType="int">
		SELECT ifnull(MAX(integrity_cost),0) as integrity_cost
		FROM tb_account_deadline_balance
		WHERE year = #{year}
		AND month = #{month}
		AND account_id = #{account_id}
	</select>
	
	<select id="AccountDepositHistoryList" parameterType="map" resultType="hashmap">
		SELECT account_id,
			   year,
			   month,
			   CASE WHEN type = 1 
			   		THEN '생계비'
			   		WHEN type = 2 
			   		THEN '일반식대'
			   		WHEN type = 3 
			   		THEN '직원식대'
			   		WHEN type = 5 
			   		THEN '보전'
			   		ELSE '미수잔액'
			   		END AS type,
			   DATE_FORMAT(input_dt, '%Y-%m-%d') as input_dt,
			   DATE_FORMAT(balance_dt, '%Y-%m-%d') as balance_dt,
			   difference_price,
			   input_price,
			   note,
			   deposit_amount
		FROM tb_account_deposit_history
		WHERE account_id = #{account_id}
		AND DATE_FORMAT(input_dt, '%Y') = #{year}
		ORDER BY year DESC, month DESC, input_dt DESC
	</select>
	
	<insert id="AccountDeadlineBalanceSave" parameterType="map">
		INSERT INTO tb_account_deadline_balance
    
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        account_id,
	        year,
	        month,
	        balance_file,
	        living_cost,
	        basic_cost,
	        employ_cost,
	        integrity_cost,
	        input_exp,
	        update_dt
	    </trim>
	    
	    VALUES
	    
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        #{account_id},
	        #{year},
	        #{month},
	        #{balance_file},
	        #{living_cost},
	        #{basic_cost},
	        #{employ_cost},
	        #{integrity_cost},
	        #{input_exp},
	        DATE_FORMAT(now(), '%Y-%m-%d')
	    </trim>
	    ON DUPLICATE KEY UPDATE
	    <trim suffixOverrides=",">
	        account_id=#{account_id},
	        year=#{year},
	        month=#{month},
	        balance_file=#{balance_file},
	        living_cost=#{living_cost},
	        basic_cost=#{basic_cost},
	        employ_cost=#{employ_cost},
	        integrity_cost=#{integrity_cost},
	        input_exp=#{input_exp}
	    </trim>
	</insert>
	
	<insert id="AccountBalancePriceSave" parameterType="map">
		INSERT INTO tb_account_balance_price
    
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        account_id,
	        balance_price,
	        update_dt,
	        before_price
	    </trim>
	    
	    VALUES
	    
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        #{account_id},
	        #{balance_price},
	        DATE_FORMAT(now(), '%Y-%m-%d'),
	        #{before_price},
	    </trim>
	    ON DUPLICATE KEY UPDATE
	    <trim suffixOverrides=",">
	        account_id=#{account_id},
	        balance_price=#{balance_price},
	        update_dt=DATE_FORMAT(now(), '%Y-%m-%d'),
	        before_price=#{before_price},
	    </trim>
	</insert>
	
	<insert id="AccountDeadlineMonthBalanceUpdate" parameterType="map">
		UPDATE tb_account_deadline_balance A
        INNER JOIN 
        (
			SELECT SUM(input_price) as input_price
				 , account_id
            FROM tb_account_deposit_history
            WHERE DATE_FORMAT(input_dt, '%Y') = #{year}
			AND DATE_FORMAT(input_dt, '%m') = #{month}
			AND account_id = #{account_id}
            GROUP BY account_id
        ) as C
        ON A.account_id = C.account_id
		SET A.month_balance_price = (A.living_cost + A.basic_cost + employ_cost + integrity_cost) - C.input_price
        WHERE (A.living_cost + A.basic_cost + employ_cost + integrity_cost) != 0
        AND A.account_id = #{account_id}
	</insert>
	
	<insert id="AccountDepositHistorySave" parameterType="map">
		INSERT INTO tb_account_deposit_history
    
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        account_id,
	        type,
	        input_dt,
	        <if test="balance_dt != null and balance_dt != ''">
	        balance_dt,
	        </if>
	        difference_price,
	        input_price,
	        note,
	        deposit_amount,
	        year,
	        month
	    </trim>
	    
	    VALUES
	    
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        #{account_id},
	        #{type},
	        CONCAT(
		      DATE_FORMAT(#{input_dt}, '%Y-%m-%d'),
		      ' ',
		      DATE_FORMAT(NOW(), '%H:%i:%s')),
	        <if test="balance_dt != null and balance_dt != ''">
	        CONCAT(
		      DATE_FORMAT(#{balance_dt}, '%Y-%m-%d'),
		      ' ',
		      DATE_FORMAT(NOW(), '%H:%i:%s')),
	        </if>
	        #{difference_price},
	        #{input_price},
	        #{note},
	        #{deposit_amount},
	        #{year},
	        #{month}
	    </trim>
	</insert>
	
		<select id="AccountDeadlineDifferencePriceSearch" parameterType="map" resultType="hashmap">
		SELECT
			(
			  CASE #{type}
			    WHEN 1 THEN IFNULL(db.living_cost, 0)
			    WHEN 2 THEN IFNULL(db.basic_cost, 0)
			    WHEN 3 THEN IFNULL(db.employ_cost, 0)
			    WHEN 5 THEN IFNULL(db.integrity_cost, 0)
			    WHEN 4 THEN IFNULL(abp.balance_price, 0)
			    ELSE 0
			  END
			  -
			  IFNULL((
			    SELECT SUM(IFNULL(dh.input_price, 0))
			    FROM tb_account_deposit_history dh
			    WHERE dh.account_id = #{account_id}
			      AND dh.year = #{year}
			      AND dh.month = #{month}
			      AND dh.type = #{type}
			      AND IFNULL(dh.note, '') NOT LIKE '%[환불]%'
			  ), 0)
			) AS difference_price
			FROM tb_account_deadline_balance db
			LEFT OUTER JOIN tb_account_balance_price abp
			ON abp.account_id = db.account_id
			WHERE db.account_id = #{account_id}
			  AND db.year = #{year}
			  AND db.month = #{month}
			LIMIT 1
	</select>
	
	<select id="AccountDeadlineFilesList" parameterType="map" resultType="hashmap">
		SELECT a.account_id, 
			   a.account_name,
		       adf.year, 
			   adf.month, 
			   adf.deadline_file,
			   adf.file_yn
		FROM tb_account a
		LEFT OUTER JOIN tb_account_deadline_files adf
		ON adf.account_id = a.account_id
		AND adf.year = #{year}
		AND adf.file_yn = 'Y'
	</select>
	
	<insert id="AccountDeadlineFilesSave" parameterType="map">
		INSERT INTO tb_account_deadline_files
    
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        account_id,
	        year,
	        month,
	        deadline_file,
	        file_yn
	    </trim>
	    
	    VALUES
	    
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        #{account_id},
	        #{year},
	        #{month},
	        #{deadline_file},
	        #{file_yn}
	    </trim>
	    
	    ON DUPLICATE KEY UPDATE
	    <trim suffixOverrides=",">
	        account_id=#{account_id},
	        year=#{year},
	        month=#{month},
	        deadline_file=#{deadline_file},
	        file_yn=#{file_yn}
	    </trim>
	</insert>
	
	<select id="AccountIssueList" parameterType="map" resultType="hashmap">
		SELECT a.account_id, 
			   a.account_name,
		       adi.year, 
			   adi.month, 
			   adi.note,
			   adi.solution,
			   adi.event_note
		FROM tb_account a
		LEFT OUTER JOIN tb_account_issue adi
		ON adi.account_id = a.account_id
		AND adi.year = #{year}
		AND adi.type = #{type}
	</select>
	
	<insert id="AccountIssueSave" parameterType="map">
		INSERT INTO tb_account_issue
    
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        account_id,
	        year,
	        month,
	        note,
	        type,
	        solution,
			event_note
	    </trim>
	    
	    VALUES
	    
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        #{account_id},
	        #{year},
	        #{month},
	        #{note},
	        #{type},
	        #{solution},
	        #{event_note}
	    </trim>
	    
	    ON DUPLICATE KEY UPDATE
	    <trim suffixOverrides=",">
	        account_id=#{account_id},
	        year=#{year},
	        month=#{month},
	        note=#{note},
	        type=#{type},
	        <if test="solution != null">
	            solution = #{solution},
	        </if>
	        <if test="event_note != null">
	            event_note = #{event_note}
	        </if>
	    </trim>
	</insert>

	<select id="AccountCommunicationMappingList" parameterType="map" resultType="hashmap">
		SELECT idx,
			   team_code,
			   type
		FROM tb_account_communication_mapping
		WHERE team_code = #{team_code}
		ORDER BY idx ASC
	</select>
	
	<insert id="AccountCommunicationMappingSave" parameterType="map">
		INSERT INTO tb_account_communication_mapping
	
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        <if test="idx != null and idx != ''">idx,</if>
	        team_code,
	        type
	    </trim>
	
	    VALUES
	
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        <if test="idx != null and idx != ''">#{idx},</if>
	        #{team_code},
	        #{type}
	    </trim>
	
	    ON DUPLICATE KEY UPDATE
	    <trim suffixOverrides=",">
	        team_code = #{team_code},
	        type = #{type}
	    </trim>
	</insert>
	
	<delete id="AccountCommunicationMappingDelete" parameterType="map">
		DELETE FROM tb_account_communication_mapping
		WHERE idx IN
		<foreach collection="ids" item="id" open="(" separator="," close=")">
			#{id}
		</foreach>
	</delete>
	
	<select id="AccountCommunicationList" parameterType="map" resultType="hashmap">
      SELECT c.idx,
            c.team_code,
            DATE_FORMAT(c.sub_date, '%Y-%m-%d') AS sub_date,
            c.account_id,
            a.account_name,
            c.type,
            c.issue,
            c.result,
            DATE_FORMAT(c.end_date, '%Y-%m-%d') AS end_date,
            c.solution,
            c.note,
            c.user_id
      FROM tb_account_communication c
      LEFT OUTER JOIN tb_account a
      ON c.account_id = a.account_id
      WHERE c.team_code = #{team_code}
      ORDER BY c.sub_date ASC, c.idx ASC
   </select>
   
   <insert id="AccountCommunicationInsert" parameterType="map">
      INSERT INTO tb_account_communication
   
       <trim prefix="(" suffix=")" suffixOverrides=",">
           team_code,
           sub_date,
           account_id,
           type,
           issue,
           result,
           end_date,
           solution,
           note,
           user_id
       </trim>
   
       VALUES
   
       <trim prefix="(" suffix=")" suffixOverrides=",">
           #{team_code},
           #{sub_date},
           #{account_id},
           #{type},
           #{issue},
           #{result},
           #{end_date},
           #{solution},
           #{note},
           #{user_id}
       </trim>
   </insert>
   
   <update id="AccountCommunicationUpdate" parameterType="map">
      UPDATE tb_account_communication
      SET team_code = #{team_code},
          sub_date = #{sub_date},
          account_id = #{account_id},
          type = #{type},
          issue = #{issue},
          result = #{result},
          end_date = #{end_date},
          solution = #{solution},
          note = #{note},
          user_id = CASE WHEN #{user_id} IS NULL OR #{user_id} = '' THEN user_id ELSE #{user_id} END
      WHERE idx = #{idx}
   </update>

	
	<!-- 배치성 데이터 -->
	<select id="BatchForPayBack" parameterType="map" resultType="hashmap">
		SELECT 
		    account_id,
		    total_days,
		    total_days * 0.15 AS payback_price,
		    count_year as year,
			count_month as month
		FROM (
		    SELECT 
		        account_id,
		       (COALESCE(day_1, 0) + COALESCE(day_2, 0) + COALESCE(day_3, 0) + COALESCE(day_4, 0) +
				 COALESCE(day_5, 0) + COALESCE(day_6, 0) + COALESCE(day_7, 0) + COALESCE(day_8, 0) +
				 COALESCE(day_9, 0) + COALESCE(day_10, 0) + COALESCE(day_11, 0) + COALESCE(day_12, 0) +
				 COALESCE(day_13, 0) + COALESCE(day_14, 0) + COALESCE(day_15, 0) + COALESCE(day_16, 0) +
				 COALESCE(day_17, 0) + COALESCE(day_18, 0) + COALESCE(day_19, 0) + COALESCE(day_20, 0) +
				 COALESCE(day_21, 0) + COALESCE(day_22, 0) + COALESCE(day_23, 0) + COALESCE(day_24, 0) +
				 COALESCE(day_25, 0) + COALESCE(day_26, 0) + COALESCE(day_27, 0) + COALESCE(day_28, 0) +
				 COALESCE(day_29, 0) + COALESCE(day_30, 0) + COALESCE(day_31, 0)
				) AS total_days,
				count_year,
				count_month
		    FROM tb_account_tally_sheet
		    WHERE count_year = #{count_year}
		    AND count_month = #{count_month}
		    AND type = 2
		) AS t
	</select>
	
	<insert id="AccountAnnualLeaveLedgerSave" parameterType="map">
		INSERT INTO tb_account_annual_leave_ledger
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        member_id,
	        ledger_dt,
	        type,
	        days,
	        reason,
	    </trim>
	    VALUES
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        #{member_id},
	        #{ledger_dt},
	        #{type},
	        #{days},
	        #{reason},
	    </trim>
	</insert>
	
	<insert id="AccountOverTimeLedgerSave" parameterType="map">
		INSERT INTO tb_account_overtime_ledger
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        member_id,
	        over_dt,
	        type,
	        times,
	        reason,
	    </trim>
	    VALUES
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        #{member_id},
	        #{over_dt},
	        #{type},
	        #{times},
	        #{reason},
	    </trim>
	</insert>
	
	<select id="AccountMappingList" parameterType="string" resultType="hashmap">
		SELECT am.type, am.name, am.biz_no 
		FROM tb_account_mapping am
		JOIN tb_account_mapping_v2 amv
		ON am.type = amv.type
		WHERE amv.account_id = #{account_id}
		AND am.del_yn = 'N'
		AND am.biz_no is not null
		AND am.biz_no != ''
	</select>
	
	<insert id="AccountPurchaseSave" parameterType="map">
		INSERT INTO tb_account_purchase_tally
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        account_id,
	        sale_id,
	        type,
	        saleDate,
	        total,
	        discount,
	        vat,
	        taxFree,
	        tax,
	        payType,
	        totalCash,
	        totalCard,
	        cardNo,
	        cardBrand,
	        bizNo,
	        receipt_image,
	        note,
	        use_name,
	        cashReceiptType,
	        user_id,
	        reg_dt,
	        receipt_type
	    </trim>
	    VALUES
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        #{account_id},
	        #{sale_id},
	        #{type},
	        DATE_FORMAT(#{saleDate}, '%Y-%m-%d'),
	        #{total},
	        #{discount},
	        #{vat},
	        #{taxFree},
	        #{tax},
	        #{payType},
	        #{totalCash},
	        #{totalCard},
	        #{cardNo},
	        #{cardBrand},
	        #{bizNo},
	        #{receipt_image},
	        #{note},
	        #{use_name},
	        #{cashReceiptType},
	        #{user_id},
	        DATE_FORMAT(NOW(), '%Y-%m-%d'),
	        #{receipt_type}
	    </trim>
	    ON DUPLICATE KEY UPDATE
	    <trim suffixOverrides=",">
	        type=#{type},
	        saleDate=DATE_FORMAT(#{saleDate}, '%Y-%m-%d'),
	        total=#{total},
	        discount=#{discount},
	        vat=#{vat},
	        taxFree=#{taxFree},
	        tax=#{tax},
	        payType=#{payType},
	        totalCash=#{totalCash},
	        totalCard=#{totalCard},
	        cardNo=#{cardNo},
	        cardBrand=#{cardBrand},
	        bizNo=#{bizNo},
	        receipt_image=IFNULL(NULLIF(#{receipt_image}, ''), receipt_image),
	        note=#{note},
	        use_name = #{use_name},
	        cashReceiptType = #{cashReceiptType},
	        mod_id = #{user_id},
	        mod_dt = DATE_FORMAT(NOW(), '%Y-%m-%d'),
	        receipt_type = #{receipt_type}
	    </trim>
	</insert>
	
	<insert id="AccountPurchaseDetailSave" parameterType="map">
		INSERT INTO tb_account_purchase_tally_detail
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        item_id,
	        sale_id,
	        name,
	        qty,
	        amount,
	        unitPrice,
	        vat,
	        tax,
	        taxType,
	        itemType,
	        note,
	        user_id,
	        reg_dt
	    </trim>
	    VALUES
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        #{item_id},
	        #{sale_id},
	        #{name},
	        #{qty},
	        #{amount},
	        #{unitPrice},
	        #{vat},
	        #{tax},
	        #{taxType},
	        #{itemType},
	        #{note},
	        #{user_id},
	        DATE_FORMAT(NOW(), '%Y-%m-%d')
	    </trim>
	    ON DUPLICATE KEY UPDATE
	    <trim suffixOverrides=",">
	        name=#{name},
	        qty=#{qty},
	        amount=#{amount},
	        unitPrice=#{unitPrice},
	        vat = #{vat},
	        tax = #{tax},
	        taxType=#{taxType},
	        itemType=#{itemType},
	        note=#{note},
	        mod_id=#{user_id},
	        mod_dt=DATE_FORMAT(NOW(), '%Y-%m-%d')
	    </trim>
	</insert>
	
	<select id="AccountPurchaseTallyList" parameterType="map" resultType="hashmap">
		SELECT a.account_id, 
			   a.account_name, 
		       amv.type, 
		       apt.use_name, 
		       DATE_FORMAT(apt.saleDate, '%Y-%m-%d') as saleDate, 
		       ifnull(apt.total, 0) as total, 
		       ifnull(apt.vat, 0) as vat,
		       ifnull(apt.taxFree, 0) as taxFree,
		       ifnull(apt.tax, 0) as tax,
		       ifnull(apt.totalCash, 0) as totalCash,
		       ifnull(apt.totalCard, 0) as totalCard,
		       apt.payType,
		       apt.cardNo,
		       apt.cardBrand,
		       apt.receipt_image,
		       apt.note,
		       apt.bizNo,
		       am.ceo_name,
		       apt.sale_id
		FROM tb_account a
		JOIN tb_account_mapping_v2 amv
		ON amv.account_id = a.account_id
		JOIN tb_account_mapping am
		ON am.type = amv.type
		LEFT OUTER JOIN tb_account_purchase_tally apt
		ON apt.account_id = a.account_id
		AND apt.type = amv.type
		WHERE a.account_id = #{account_id}
		AND apt.type = #{type}
		<if test="payType == 1">
	        AND apt.totalCash != 0
        </if>
        <if test="payType == 2">
	        AND apt.totalCard != 0
        </if>
        AND apt.saleDate BETWEEN DATE_FORMAT(#{fromDate}, '%Y-%m-%d') AND DATE_FORMAT(#{toDate}, '%Y-%m-%d')
        ORDER BY apt.saleDate ASC, apt.sale_id ASC
	</select>
	
	<select id="AccountPurchaseDetailList" parameterType="map" resultType="hashmap">
		SELECT apt.account_id, 
			   aptd.sale_id,
			   aptd.item_id,
			   a.account_name,
			   DATE_FORMAT(apt.saleDate, '%Y-%m-%d') as saleDate, 
			   aptd.name, 
			   aptd.qty, 
			   aptd.unitPrice, 
			   aptd.amount, 
			   aptd.taxType, 
			   aptd.itemType,
			   apt.receipt_image
		FROM tb_account a
		JOIN tb_account_purchase_tally apt
		ON apt.account_id = a.account_id
		JOIN tb_account_purchase_tally_detail aptd
		ON aptd.sale_id = apt.sale_id
		WHERE a.account_id = #{account_id}
		AND a.account_type = #{type}
		<if test="payType == 1">
	        AND apt.totalCash != 0
        </if>
        <if test="payType == 2">
	        AND apt.totalCard != 0
        </if>
		AND apt.saleDate BETWEEN DATE_FORMAT(#{fromDate}, '%Y-%m-%d') AND DATE_FORMAT(#{toDate}, '%Y-%m-%d')
		ORDER BY apt.saleDate ASC, apt.sale_id ASC, aptd.item_id ASC
	</select>
	
	<select id="AccountPurchaseDetailList_tmp" parameterType="map" resultType="hashmap">
		SELECT apt.account_id, 
			   aptd.sale_id,
			   aptd.item_id,
			   a.account_name,
			   DATE_FORMAT(apt.saleDate, '%Y-%m-%d') as saleDate, 
			   aptd.name, 
			   aptd.qty, 
			   aptd.unitPrice, 
			   aptd.vat,
			   aptd.tax,
			   aptd.amount, 
			   aptd.taxType, 
			   aptd.itemType,
			   apt.receipt_image
		FROM tb_account a
		JOIN tb_account_purchase_tally apt
		ON apt.account_id = a.account_id
		JOIN tb_account_purchase_tally_detail aptd
		ON aptd.sale_id = apt.sale_id
		WHERE aptd.sale_id = #{sale_id}
		ORDER BY apt.saleDate ASC, apt.sale_id ASC, aptd.item_id ASC
	</select>
	
	<select id="AccountPersonPurchaseTallyList" parameterType="map" resultType="hashmap">
		SELECT a.account_id, 
			   a.account_name, 
		       amv.type, 
		       apt.use_name, 
		       DATE_FORMAT(apt.saleDate, '%Y-%m-%d') as saleDate, 
		       ifnull(apt.total, 0) as total, 
		       ifnull(apt.vat, 0) as vat,
		       ifnull(apt.taxFree, 0) as taxFree,
		       ifnull(apt.tax, 0) as tax,
		       ifnull(apt.totalCash, 0) as totalCash,
		       ifnull(apt.totalCard, 0) as totalCard,
		       apt.payType,
		       apt.cardNo,
		       apt.cardBrand,
		       apt.receipt_image,
		       apt.note,
		       apt.bizNo,
		       am.ceo_name,
		       apt.sale_id,
		       apt.receipt_type
		FROM tb_account a
		JOIN tb_account_mapping_v2 amv
		ON amv.account_id = a.account_id
		JOIN tb_account_mapping am
		ON am.type = amv.type
		LEFT OUTER JOIN tb_account_purchase_tally apt
		ON apt.account_id = a.account_id
		AND apt.type = amv.type
		WHERE a.account_id = #{account_id}
		AND apt.type in (1008, 1)
		<if test="payType == 1">
	        AND apt.totalCash != 0
        </if>
        <if test="payType == 2">
	        AND apt.totalCard != 0
        </if>
        AND DATE_FORMAT(apt.saleDate, '%Y') = ${year}
		AND DATE_FORMAT(apt.saleDate, '%m') = ${month}
        ORDER BY apt.saleDate ASC, apt.sale_id ASC
	</select>
	
	<select id="AccountPersonPurchaseDetailList" parameterType="map" resultType="hashmap">
		SELECT apt.account_id, 
			   aptd.sale_id,
			   aptd.item_id,
			   a.account_name,
			   DATE_FORMAT(apt.saleDate, '%Y-%m-%d') as saleDate, 
			   aptd.name, 
			   aptd.qty, 
			   aptd.unitPrice, 
			   aptd.vat,
			   aptd.tax,
			   aptd.amount, 
			   aptd.taxType, 
			   aptd.itemType,
			   apt.receipt_image
		FROM tb_account a
		JOIN tb_account_purchase_tally apt
		ON apt.account_id = a.account_id
		JOIN tb_account_purchase_tally_detail aptd
		ON aptd.sale_id = apt.sale_id
		WHERE aptd.sale_id = #{sale_id}
		ORDER BY apt.saleDate ASC, apt.sale_id ASC, aptd.item_id ASC
	</select>
	
	<select id="AccountPurchaseTallyPaymentList" parameterType="map" resultType="hashmap">
		SELECT account_id, 
			   sale_id,
			   use_name, 
		       type, 
		       DATE_FORMAT(saleDate, '%Y-%m-%d') as saleDate, 
		       ifnull(total, 0) as total, 
		       ifnull(vat, 0) as vat,
		       ifnull(taxFree, 0) as taxFree,
		       ifnull(tax, 0) as tax,
		       ifnull(totalCash, 0) as totalCash,
		       ifnull(totalCard, 0) as totalCard,
		       payType,
		       cardNo,
		       cardBrand,
		       receipt_image,
		       note,
		       bizNo,
		       receipt_type,
		       cashReceiptType as cash_receipt_type
		FROM tb_account_purchase_tally
		WHERE account_id = #{account_id}
		AND type = #{type}
        AND saleDate = DATE_FORMAT(#{saleDate}, '%Y-%m-%d')
	</select>
	
	<select id="HeadOfficeCorporateCardList" parameterType="string" resultType="hashmap">
		SELECT idx, card_brand, card_no, DATE_FORMAT(reg_dt, '%Y-%m-%d') as reg_dt, user_id, del_yn 
		FROM tb_headoffice_corporate_card
	</select>
	
	<select id="HeadOfficeCorporateCardPaymentList" parameterType="map" resultType="hashmap">
		SELECT sale_id, 
			   account_id, 
			   DATE_FORMAT(payment_dt, '%Y-%m-%d') as payment_dt, 
			   use_name, 
			   bizNo, 
			   total, 
			   vat, 
			   taxFree, 
			   tax,
			   totalCard, 
			   cardNo,
			   cardBrand, 
			   receipt_image, 
			   note, 
			   DATE_FORMAT(reg_dt, '%Y-%m-%d') as reg_dt, 
			   user_id,
			   receipt_type,
			   idx
		FROM tb_headoffice_corporate_card_payment_list
		WHERE DATE_FORMAT(payment_dt, '%Y') = ${year}
		AND DATE_FORMAT(payment_dt, '%m') = ${month}
		AND account_id = #{account_id}
		ORDER BY payment_dt ASC, sale_id ASC
	</select>
	
	<select id="HeadOfficeCorporateCardPaymentDetailList" parameterType="map" resultType="hashmap">
		SELECT idx, sale_id, name, qty, amount, unitPrice, taxType, itemType
		FROM tb_headoffice_corporate_card_payment_detail_list
		WHERE sale_id = #{sale_id}
	</select>
	
	<insert id="HeadOfficeCorporateCardSave" parameterType="map">
		INSERT INTO tb_headoffice_corporate_card
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        idx,
	        card_brand,
	        card_no,
	        reg_dt,
	        user_id,
	        del_yn
	    </trim>
	    VALUES
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        #{idx},
	        #{card_brand},
	        #{card_no},
	        DATE_FORMAT(NOW(), '%Y-%m-%d'),
	        #{user_id},
	        #{del_yn},
	    </trim>
	    ON DUPLICATE KEY UPDATE
	    <trim suffixOverrides=",">
	        idx=#{idx},
	        card_brand=#{card_brand},
	        card_no=#{card_no},
	        reg_dt=DATE_FORMAT(NOW(), '%Y-%m-%d'),
	        user_id=#{user_id},
	        del_yn=#{del_yn},
	    </trim>
	</insert>
	
	<insert id="HeadOfficeCorporateCardPaymentSave" parameterType="map">
		INSERT INTO tb_headoffice_corporate_card_payment_list
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        sale_id,
	        account_id,
	        payment_dt,
	        use_name,
	        bizNo,
	        total,
	        vat,
	        taxFree,
	        tax,
	        totalCard,
	        cardNo,
	        cardBrand,
	        receipt_image,
	        note,
	        reg_dt,
	        user_id,
	        receipt_type,
	        idx
	    </trim>
	    VALUES
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        #{sale_id},
	        #{account_id},
	        DATE_FORMAT(#{payment_dt}, '%Y-%m-%d'),
	        #{use_name},
	        #{bizNo},
	        #{total},
	        #{vat},
	        #{taxFree},
	        #{tax},
	        #{totalCard},
	        #{cardNo},
	        #{cardBrand},
	        #{receipt_image},
	        #{note},
	        DATE_FORMAT(NOW(), '%Y-%m-%d'),
	        #{user_id},
	        #{receipt_type},
	        #{idx}
	    </trim>
	    ON DUPLICATE KEY UPDATE
	    <trim suffixOverrides=",">
	        sale_id=#{sale_id},
	        account_id=#{account_id},
	        payment_dt=DATE_FORMAT(#{payment_dt}, '%Y-%m-%d'),
	        use_name=#{use_name},
	        bizNo=#{bizNo},
	        total=#{total},
	        vat=#{vat},
	        taxFree=#{taxFree},
	        tax=#{tax},
	        totalCard=#{totalCard},
	        cardNo=#{cardNo},
	        cardBrand=#{cardBrand},
	        receipt_image=IFNULL(NULLIF(#{receipt_image}, ''), receipt_image),
	        note=#{note},
	        reg_dt=DATE_FORMAT(NOW(), '%Y-%m-%d'),
	        user_id=#{user_id},
	        receipt_type=#{receipt_type},
	        idx=#{idx}
	    </trim>
	</insert>
	
	<insert id="HeadOfficeCorporateCardPaymentDetailLSave" parameterType="map">
		INSERT INTO tb_headoffice_corporate_card_payment_detail_list
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	    	idx,
	        sale_id,
	        name,
	        qty,
	        amount,
	        unitPrice,
	        taxType,
	        itemType
	    </trim>
	    VALUES
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	    	#{idx},
	        #{sale_id},
	        #{name},
	        #{qty},
	        #{amount},
	        #{unitPrice},
	        #{taxType},
	        #{itemType}
	    </trim>
	    ON DUPLICATE KEY UPDATE
	    <trim suffixOverrides=",">
	    	idx=#{idx},
	        sale_id=#{sale_id},
	        name=#{name},
	        qty=#{qty},
	        amount=#{amount},
	        unitPrice=#{unitPrice},
	        taxType=#{taxType},
	        itemType=#{itemType}
	    </trim>
	</insert>
	
	<select id="AccountCorporateCardList" parameterType="string" resultType="hashmap">
		SELECT idx, account_id, card_brand, card_no, DATE_FORMAT(reg_dt, '%Y-%m-%d') as reg_dt, user_id, del_yn 
		FROM tb_account_corporate_card
		WHERE account_id = #{account_id}
	</select>
	
	<select id="AccountCorporateCardPaymentList" parameterType="map" resultType="hashmap">
		SELECT sale_id, account_id, DATE_FORMAT(payment_dt, '%Y-%m-%d') as payment_dt, use_name, bizNo, total, vat, tax, taxFree, totalCard, cardNo,cardBrand, receipt_image, note, DATE_FORMAT(reg_dt, '%Y-%m-%d') as reg_dt, user_id, receipt_type, idx
		FROM tb_account_corporate_card_payment_list
		<where>
		    <choose>
		        <when test="year != null and year != ''">
		            DATE_FORMAT(payment_dt, '%Y') = ${year}
		            AND DATE_FORMAT(payment_dt, '%m') = ${month}
		        </when>
		        <otherwise>
		            DATE_FORMAT(payment_dt, '%Y-%m-%d') = #{payment_dt}
		        </otherwise>
		    </choose>
		    AND account_id = #{account_id}
		</where>
		ORDER BY payment_dt ASC, sale_id ASC
	</select>
	
	<select id="AccountCorporateCardPaymentDetailList" parameterType="string" resultType="hashmap">
		SELECT idx, sale_id, name, qty, amount, unitPrice, taxType, itemType
		FROM tb_account_corporate_card_payment_detail_list
		WHERE sale_id = #{sale_id}
	</select>
	
	<insert id="AccountCorporateCardSave" parameterType="map">
		INSERT INTO tb_account_corporate_card
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        idx,
	        account_id,
	        card_brand,
	        card_no,
	        reg_dt,
	        user_id,
	        del_yn
	    </trim>
	    VALUES
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        #{idx},
	        #{account_id},
	        #{card_brand},
	        #{card_no},
	        DATE_FORMAT(NOW(), '%Y-%m-%d'),
	        #{user_id},
	        #{del_yn},
	    </trim>
	    ON DUPLICATE KEY UPDATE
	    <trim suffixOverrides=",">
	        idx=#{idx},
	        account_id=#{account_id},
	        card_brand=#{card_brand},
	        card_no=#{card_no},
	        reg_dt=DATE_FORMAT(NOW(), '%Y-%m-%d'),
	        user_id=#{user_id},
	        del_yn=#{del_yn},
	    </trim>
	</insert>
	
	<insert id="AccountCorporateCardPaymentSave" parameterType="map">
		INSERT INTO tb_account_corporate_card_payment_list
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        sale_id,
	        account_id,
	        payment_dt,
	        use_name,
	        bizNo,
	        total,
	        vat,
	        taxFree,
	        tax,
	        totalCard,
	        cardNo,
	        cardBrand,
	        receipt_image,
	        note,
	        reg_dt,
	        user_id,
	        receipt_type,
	        idx
	    </trim>
	    VALUES
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        #{sale_id},
	        #{account_id},
	        DATE_FORMAT(#{payment_dt}, '%Y-%m-%d'),
	        #{use_name},
	        #{bizNo},
	        #{total},
	        #{vat},
	        #{taxFree},
	        #{tax},
	        #{totalCard},
	        #{cardNo},
	        #{cardBrand},
	        #{receipt_image},
	        #{note},
	        DATE_FORMAT(NOW(), '%Y-%m-%d'),
	        #{user_id},
	        #{receipt_type},
	        #{idx}
	    </trim>
	    ON DUPLICATE KEY UPDATE
	    <trim suffixOverrides=",">
	        sale_id=#{sale_id},
	        account_id=#{account_id},
	        payment_dt=DATE_FORMAT(#{payment_dt}, '%Y-%m-%d'),
	        use_name=#{use_name},
	        bizNo=#{bizNo},
	        total=#{total},
	        vat=#{vat},
	        taxFree=#{taxFree},
	        tax=#{tax},
	        totalCard=#{totalCard},
	        cardNo=#{cardNo},
	        cardBrand=#{cardBrand},
	        receipt_image=IFNULL(NULLIF(#{receipt_image}, ''), receipt_image),
	        note=#{note},
	        reg_dt=DATE_FORMAT(NOW(), '%Y-%m-%d'),
	        user_id=#{user_id},
	        receipt_type=#{receipt_type},
	        idx=#{idx}
	    </trim>
	</insert>
	
	<insert id="AccountCorporateCardPaymentDetailLSave" parameterType="map">
		INSERT INTO tb_account_corporate_card_payment_detail_list
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	    	idx,
	        sale_id,
	        name,
	        qty,
	        amount,
	        unitPrice,
	        taxType,
	        itemType
	    </trim>
	    VALUES
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	    	#{idx},
	        #{sale_id},
	        #{name},
	        #{qty},
	        #{amount},
	        #{unitPrice},
	        #{taxType},
	        #{itemType}
	    </trim>
	    ON DUPLICATE KEY UPDATE
	    <trim suffixOverrides=",">
	    	idx=#{idx},
	        sale_id=#{sale_id},
	        name=#{name},
	        qty=#{qty},
	        amount=#{amount},
	        unitPrice=#{unitPrice},
	        taxType=#{taxType},
	        itemType=#{itemType}
	    </trim>
	</insert>
	
	<select id="TallySheetCorporateCardPaymentSave" statementType="CALLABLE" parameterType="map">
	    { CALL sp_sync_corp_card_to_tally_sheet_one_day(
	        #{account_id, mode=IN, jdbcType=VARCHAR},
	        #{payment_dt, mode=IN, jdbcType=VARCHAR},
	        #{result, mode=OUT, jdbcType=INTEGER}
	    ) }
	</select>
	
	<select id="TallySheetCorporateCardPaymentSaveV2" statementType="CALLABLE" parameterType="map">
	    { CALL sp_sync_corp_card_to_tally_sheet_one_day_v2(
	        #{account_id, mode=IN, jdbcType=VARCHAR},
	        #{payment_dt, mode=IN, jdbcType=VARCHAR},
	        #{sale_id, mode=IN, jdbcType=VARCHAR},
	        #{type, mode=IN, jdbcType=INTEGER},
	        #{result, mode=OUT, jdbcType=INTEGER}
	    ) }
	</select>
	
	<select id="TallySheetPaymentSave" statementType="CALLABLE" parameterType="map">
	    { CALL sp_sync_tally_sheet_one_day(
	        #{account_id, mode=IN, jdbcType=VARCHAR},
	        #{saleDate, mode=IN, jdbcType=VARCHAR},
	        #{sale_id, mode=IN, jdbcType=VARCHAR},
	        #{type, mode=IN, jdbcType=INTEGER},
	        #{result, mode=OUT, jdbcType=INTEGER}
	    ) }
	</select>
	
	<insert id="AccountMemberDispatchMappingSave" parameterType="map">
		INSERT INTO tb_account_member_dispatch_mapping
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	    	member_id,
	        account_id,
	        dispatch_account_id,
	        record_year,
	        record_month,
	        record_date,
	        del_yn,
	        reg_dt,
	        user_id
	    </trim>
	    VALUES
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	    	#{member_id},
	        #{account_id},
	        #{dispatch_account_id},
	        #{record_year},
	        #{record_month},
	        #{record_date},
	        'N',
	        DATE_FORMAT(NOW(), '%Y-%m-%d'),
	        #{user_id}
	    </trim>
	    ON DUPLICATE KEY UPDATE
	    <trim suffixOverrides=",">
	    	    member_id=#{member_id},
	        account_id=#{account_id},
	        dispatch_account_id=#{dispatch_account_id},
	        record_year=#{record_year},
	        record_month=#{record_month},
	        record_date=#{record_date},
	        del_yn=#{del_yn},
	        reg_dt=DATE_FORMAT(NOW(), '%Y-%m-%d'),
	        user_id=#{user_id}
	    </trim>
	</insert>
	
		<select id="AccountMemberDispatchMappingList" parameterType="map" resultType="hashmap">
		SELECT
			T.idx,
			T.member_id,
			T.account_id,
			T.dispatch_account_id,
			T3.name,
			T2.account_name AS origin_account_name,
			(SELECT account_name FROM tb_account WHERE account_id = T.dispatch_account_id) AS dispatch_account_name,
			CONCAT(T.record_year, '-', T.record_month, '-', T.record_date) as record_date,
			case WHEN T3.position_type = 1 THEN '영양사'
             WHEN T3.position_type = 2 THEN '조리팀장'
                 WHEN T3.position_type = 3 THEN '조리장'
                 WHEN T3.position_type = 4 THEN '조리사'
                 WHEN T3.position_type = 5 THEN '조리원'
                 ELSE '유틸' END AS position
		FROM tb_account_member_dispatch_mapping T
		JOIN tb_account T2
		ON T2.account_id = T.account_id
		JOIN tb_account_members T3
		ON T3.member_id = T.member_id
		WHERE 1=1
		<if test="member_id != null and member_id != ''">
			AND T.member_id = #{member_id}
		</if>
		<if test="dispatch_account_id != null and dispatch_account_id != ''">
			AND T.dispatch_account_id = #{dispatch_account_id}
		</if>
		<if test="account_id != null and account_id != ''">
			AND T.account_id = #{account_id}
		</if>
		<if test="record_year != null and record_year != ''">
			AND T.record_year = #{record_year}
		</if>
		<if test="record_month != null and record_month != ''">
			AND T.record_month = #{record_month}
		</if>
	</select>
	
	<select id="AccountDepositEmptyUse" parameterType="map" resultType="integer">
		SELECT COUNT(1)
		FROM tb_account_deposit_history
		WHERE year = #{year}
		AND month = #{month}
		AND account_id = #{account_id}
	</select>

	<update id="AccountDepositHistoryRecalc" parameterType="map">
		UPDATE tb_account_deposit_history dh
		INNER JOIN (
		    SELECT
		        t.account_id,
		        t.year,
		        t.month,
		        t.type,
		        t.max_input_dt,
		        -- 기대총액 = 마감비용 + 전월 difference
		        (
		            CASE t.type
		                WHEN 1 THEN IFNULL(adb.living_cost, 0)
		                WHEN 2 THEN IFNULL(adb.basic_cost, 0)
		                WHEN 3 THEN IFNULL(adb.employ_cost, 0)
		                WHEN 5 THEN IFNULL(adb.integrity_cost, 0)
		                ELSE 0
		            END
		            + IFNULL(prev.difference_price, 0)
		        ) AS expected_total,
		        -- 당월 입금합계
		        IFNULL(paid.paid_total, 0) AS paid_total
		    FROM (
		        -- 당월 타입별 max(input_dt)
		        SELECT
		            account_id,
		            year,
		            month,
		            type,
		            MAX(input_dt) AS max_input_dt
		        FROM tb_account_deposit_history
		        WHERE account_id = #{account_id}
		          AND year = #{year}
		          AND month = #{month}
		          AND type IN (1,2,3,5)
		          AND IFNULL(note, '') NOT LIKE '%[환불]%'
		        GROUP BY account_id, year, month, type
		    ) t
		    INNER JOIN tb_account_deadline_balance adb
		        ON adb.account_id = t.account_id
		       AND adb.year = t.year
		       AND adb.month = t.month
		
		    -- 전월 최신 difference_price
		    LEFT JOIN (
		        SELECT
		            p.account_id,
		            p.type,
		            p.difference_price
		        FROM tb_account_deposit_history p
		        INNER JOIN (
		            SELECT
		                account_id,
		                type,
		                MAX(input_dt) AS max_dt
		            FROM tb_account_deposit_history
		            WHERE account_id = #{account_id}
		              AND year  = CASE WHEN #{month} = 1 THEN #{year} - 1 ELSE #{year} END
		              AND month = CASE WHEN #{month} = 1 THEN 12        ELSE #{month} - 1 END
		              AND IFNULL(note, '') NOT LIKE '%[환불]%'
		            GROUP BY account_id, type
		        ) pm
		            ON pm.account_id = p.account_id
		           AND pm.type = p.type
		           AND pm.max_dt = p.input_dt
		        WHERE IFNULL(p.note, '') NOT LIKE '%[환불]%'
		    ) prev
		        ON prev.account_id = t.account_id
		       AND prev.type = t.type
		
		    -- 당월 타입별 입금합계
		    LEFT JOIN (
		        SELECT
		            account_id,
		            type,
		            SUM(IFNULL(input_price, 0)) AS paid_total
		        FROM tb_account_deposit_history
		        WHERE account_id = #{account_id}
		          AND year = #{year}
		          AND month = #{month}
		          AND IFNULL(note, '') NOT LIKE '%[환불]%'
		        GROUP BY account_id, type
		    ) paid
		        ON paid.account_id = t.account_id
		       AND paid.type = t.type
		) calc
		    ON calc.account_id = dh.account_id
		   AND calc.year = dh.year
		   AND calc.month = dh.month
		   AND calc.type = dh.type
		   AND calc.max_input_dt = dh.input_dt
		
		SET
		    -- 기대총액 - (현재행 제외 누적입금)
		    dh.deposit_amount   = calc.expected_total - (calc.paid_total - IFNULL(dh.input_price, 0)),
		    -- 기대총액 - 누적입금 
		    dh.difference_price = calc.expected_total - calc.paid_total
		
		WHERE dh.account_id = #{account_id}
		  AND dh.year = #{year}
		  AND dh.month = #{month}
		  AND dh.type IN (1,2,3,5)
		  AND IFNULL(dh.note, '') NOT LIKE '%[환불]%';
	</update>
	
</mapper>
